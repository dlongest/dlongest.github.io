<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Code Like A Champion</title>
		
		 <link href="/css/bootstrap.css" rel="stylesheet">
		 <script type="text/javascript" src="/js/jquery.js"></script>
		<script type="text/javascript" src="/js/bootstrap.js"></script>		
    <!-- Custom CSS -->
		<link href="/css/logo-nav.css" rel="stylesheet" />	
		<link href="/css/custom.css" rel="stylesheet" />
		<link rel="stylesheet" href="/css/solarized-dark.css" type="text/css"/> 

		<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css' />
    </head>
    <body>
	 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">
                    <img id="logo" src='/images/logo.png' width="125" height="125" />
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/about.html">About</a>
                    </li>
					  <li>
                        <a href="#">Categories</a>
                    </li>                                       
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>	

<div class="container">
<div class="row">
 <div class="col-lg-12">		
          
	<h2>Code Like A Champion Launched</h2>
	<div class="date">27 January 2015</div>	
	<div class="post">
	<p>Almost a year since I first installed Jekyll and produced a few entries, followed by design work by a now former colleague of mine, and recently many hours of hacking on stylesheets, I&#39;m happy to finally officially launch <em>Code Like A Champion</em>, a blog focused on system design and  software development practices particularly in the .NET arena.  There&#39;s thousands of such blogs on the Internet (maybe millions): what makes this one special?  Well there&#39;s actually one primary focus of this blog that hasn&#39;t been mentioned yet, one that is vital not just to the practice of developing software professionally but to being a successful professional in any field.  But before the great unveiling, allow me a digression.   </p>

<p>The art and profession of software development has developed (no pun intended) a bit of a bad name in some ways.  The media salivates over reports of sexism, racism, intolerance, and just general jerkiness emanating from hotshot young devs at big name software firms.  Some of that is just a numbers game:  given a large group of people in any field, some of them will be unsavory characters (so-called brogrammers&quot;).  But in terms of such a group, those attitudes are not dissimilar from another group of highly paid, fairly immature individuals who have spent a number of years being courted, wooed, and just generally made to feel like they are a cut above: pro athletes. Most of us can&#39;t imagine what it&#39;s like to throw a touchdown pass on a field with 80,000 people watching any more than we can what it likes to cash in 7 figures worth of stock options. But the point of this post and this blog is not to dwell on things out of our control.  In contrast, this blog is about really one topic:  being a champion.  </p>

<h3>What does it mean to be a champion?</h3>

<p>So I&#39;m sure this question has struck you by now, if not earlier:  what does he mean be a champion and isn&#39;t that the same macho attitude he just railed against?  Being a champion has nothing to do with arrogance or intolerance, it isn&#39;t a function of rich or poor, of a high title or an entry-level one, of being an expert in a field or a novice.  And most importantly, being a champion is not a matter of wins and losses.  </p>

<p>Well then, what is it?  Let&#39;s hear from some experts in the field first.</p>

<blockquote>"We will either find a way, or make one." - Hannibal, <em>Carthaginian general</em></blockquote>

<blockquote>"The spirit, the will to win, and the will to excel are the things that endure. These qualities are so much more important than the events that occur."  - Vince Lombardi, <em>legendary football coach</em></blockquote>

<blockquote>"The greatest reward for doing is the opportunity to do more." - Jonas Salk, <em>discovered first polio vaccine</em></blockquote>

<blockquote>"The successful warrior is the average man, with laser-like focus"
 - Bruce Lee, <em>champion martial artist and actor</em></blockquote>

<blockquote>"Start where you are.  Do what you can.  Use what you have."
- Arthur Ashe, <em>tennis player</em></blockquote> 

<blockquote>"We are what we repeatedly do. Excellence, then, is not an act, but a habit."
-Aristotle, <em>philosopher</em></blockquote>

<blockquote>"Accept the challenges, so that you may feel the exhilaration of victory." - <em>General George S. Patton</em></blockquote>

<p><img src="/images/winners-vs-losers.png"  /></p>

<h3>I don&#39;t play sports for a living, how does this help me?</h3>

<p>Well first, most of the quotes above were not from a sports figure at all.  Hannibal, the famous general, led his men from Carthage (in north Africa) through Europe and into Italy where he spent years fighting Rome.  Rome, the greatest city on Earth, sought Hannibal&#39;s destruction, but even with him thousands of miles from home, they were unable to defeat the great general and his army (at least directly).  Hannibal led his men on a march through the freezing Alps en route to Rome because he refused to be conquered and because he instilled this spirit and trust in his men.  Jonas Salk discovered the first polio vaccine.  For most people, that&#39;s a lifetime achievement, an opportunity to rest on one&#39;s laurels.  But not to Salk, who pressed forward to eradicate polio and turn his attention to other conditions.  </p>

<h3>Okay, okay, I get it.  So what&#39;s a champion software developer?</h3>

<p>Being a champion in any field, to me, is about one thing: attitude.  I have known a lot of incredibly talented people who were thwarted at every turn by their own attitudes.  Attitude in this context includes a lot of things.  Some people pride themselves on being &quot;realists&quot; and &quot;telling it like it is&quot;, at least in their own minds.  But it generally takes a minimal amount of skill to point out the problems and issues with something.  And it takes less skill than that to continually harp on issues.  But champions view problems as opportunities:  an opportunity to do something new or different, an opportunity to push the boundaries.  </p>

<p>Sometimes attitude is in the view of one&#39;s job, often expressed as &quot;I do X and you do Y.&quot;  But in the software development teams I&#39;ve been on, ultra-specialization is a negative, not a positive.  Yes, there is definite value in knowing something at a deep level, but I&#39;m talking about someone who will only do one particular job with no mind to go outside of it.  In the Agile teams that are more and more common today, there is little room for someone not willing to go outside their current skillset, but I see it too often.  Why are otherwise smart people so resistant to this?  Lot of reasons, but the most common one I&#39;ve observed is the fear of being a novice.  Expertise in something is hard won and many people are loathe to give it up, to return to being a beginner, to struggle and to risk a perception that they&#39;re not catching on fast enough or that maybe their initial success was all a sham. But the world today is different from the world yesterday; today demands new skills and if we don&#39;t develop them, someone else will come along that has those skills and we will be out of a job.  Instead, a champion looks for opportunities to grow their skills and learn something new, to risk temporarily looking foolish to come out with more skills.  A champion must improve every day:  every day we must be better than the last.  </p>

<p>Finally, a common attitude I see is that one&#39;s work environment is inflicted or imposed upon you by &quot;management&quot; instead of something to be shaped. A common attitude I hear is &quot;Well management will never let us write more unit tests&quot; or &quot;I understand what you&#39;re saying about code reviews, but management won&#39;t let us take the time.&quot;  But if pressed, usually &quot;management&quot; has not communicated any such thing, but rather people are either afraid to push for change or afraid to take a stand.  Yes, sometimes management will decide things that are contrary to what we, on the ground, might want or think best.  But that does not remove the obligation to identify practices and approaches that would represent meaningful value and to push for their adoption.  You miss 100% of the shots you don&#39;t take and an idea you don&#39;t propose will not be adopted.  It takes courage to speak up, to introduce an idea, to offer it up for criticism by peers.  But a champion rises above that.    </p>

<h3>I&#39;m ready to be a champion.  What will that mean for this blog?</h3>

<p>In years I&#39;ve spent training in-house developers, acquiring skill in a new language or pattern is about one thing: changing one&#39;s mindset.  The best example I can offer is SQL.  There is a lot of really awful SQL out there (where &quot;awful&quot; means either &quot;ugly&quot; or &quot;not performant&quot;).  And why is that?  SQL isn&#39;t a particularly difficult language to learn syntactically.  It&#39;s pretty easy to put together simple queries and get some results.  Usually you can do a lot more useful stuff in it faster than you can in a language like C#.  But why is so much of it awful?  Well typically, developers learn SQL after they already know one or more imperative or object-oriented languages.  But SQL is neither of those:  it is declarative.  The SQL query engine exists to parse your query and convert it into physical operations.  Too many developers write SQL as if they&#39;re (subconsciously) trying to piece the results together the way they would manually.  But learning to write efficient, beautiful SQL is about one thing:  changing one&#39;s mindset to the language of sets.  Instead of instructing the query engine how to gather the results, SQL should be written to simply describe what should be true about elements in the result set; let the query engine figure out how to put it together (that&#39;s why it&#39;s paid the big bucks, after all).  </p>

<p>Learning to be a champion also requires a shift in mindset:
* We must be mindful of our day to day practices and improve them continuously
* We must grow our skills as if our lives depended on it
* We must solve problems, not just point them out
* We must take a stand for things we believe in
* We must raise up our teammates
* We must make commitments, not promises</p>

<p>This blog will focus on fundamentals in system design and software development that often go uncovered or with too little depth and explore them more fully with code examples and suggested resources. </p>
 	
	</div>
      
	<h2>Extending the MVC Default Model Binder</h2>
	<div class="date">20 January 2015</div>	
	<div class="post">
	<p>In the <a href="/2014/12/14/writing-a-custom-mvc-model-validator.html">last post</a>, I talked about authoring custom MVC model validators that can be plugged into MVC&#39;s model validation pipeline.  In this post, I will go into some details on how we used a custom model binder to execute some logic after default model validation, but prior to MVC&#39;s model validation being executed.  </p>

<p>In the login application we were writing, there were two cases when we wanted to update the model prior to validation (so that validation would apply), but I didn&#39;t want to write a separate per-type model binder.  In MVC, you can define the application-wide model binder in the application root by doing:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="n">ModelBinders</span><span class="p">.</span><span class="n">Binders</span><span class="p">.</span><span class="n">DefaultBinder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyCustomModelBinder</span><span class="p">();</span>
</code></pre></div>
<p>This binder will completely replace the default binder although generally it&#39;s easiest to inherit from the <code>DefaultModelBinder</code> and just extend the necessary method.  But figuring out exactly what to extend and what to reuse isn&#39;t necessarily obvious.  </p>

<p>In our case, there were a few things we needed to do:
- We needed to pass values between web requests, but in some cases the values were sensitive so we encrypted them as hidden fields, but needed to decrypt them automatically during model binding
- The vendor stack that actually provides the backing store will provide some user-specific data in the HTTP header on certain views and we wanted to automatically bind those</p>

<p>In both cases, it would be possible to extend one of the MVC components to do these jobs, but a couple things bothered me:
- Each time we came up with additional model binding that needed to occur, we would have to implement a new model binder and figure out how to incorporate previously logic or violate Open-Closed and keep making changes to our binder.
- We could write a HTTP Header Value Provider, but it was only needed a fraction of times for a couple specific fields and the property on the view model we would populate had a different name so would have to figure out some alias system
- It is possible to write per-type model binders and that might have worked for the cases where we were populating header values into the view model (since there were really 3 use-case specific ones of these), but our decryption can theoretically apply to fields on any view model and I didn&#39;t want to have to define a per-type binder when the goal of encryption was to simply annotate properties and have it work. </p>

<p>So it occurred to us that what we wanted to have happen was:
- Use the <code>DefaultModelBinder</code> up to the point when it runs model validation
- At this point, run components against the completely bound model that would update the model as they saw fit (again, similar to model binding, hence the timing)
- Once all those components completed, have the <code>DefaultModelBinder</code> run its custom validation logic as it normally would. </p>

<p>This brings me to the first key in the process:  what method in the <code>DefaultModelBinder</code> needs to be overridden to give us access to a completely bound but not yet validated view model?  The answer:  OnModelUpdated.  The below snippet shows the implementation of the OnModelUpdated method on DefaultModelBinder pulled from the MVC source code on CodePlex.  This is the only method that uses the model validators by way of using the application-wide static ModelValidator instance to get the validators to iterate through.  </p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">OnModelUpdated</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">controllerContext</span><span class="p">,</span> <span class="n">ModelBindingContext</span> <span class="n">bindingContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">startedValid</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;(</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="n">ModelValidationResult</span> <span class="n">validationResult</span> <span class="k">in</span> <span class="n">ModelValidator</span><span class="p">.</span><span class="n">GetModelValidator</span><span class="p">(</span><span class="n">bindingContext</span><span class="p">.</span><span class="n">ModelMetadata</span><span class="p">,</span> <span class="n">controllerContext</span><span class="p">).</span><span class="n">Validate</span><span class="p">(</span><span class="k">null</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">subPropertyName</span> <span class="p">=</span> <span class="n">CreateSubPropertyName</span><span class="p">(</span><span class="n">bindingContext</span><span class="p">.</span><span class="n">ModelName</span><span class="p">,</span> <span class="n">validationResult</span><span class="p">.</span><span class="n">MemberName</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(!</span><span class="n">startedValid</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">subPropertyName</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">startedValid</span><span class="p">[</span><span class="n">subPropertyName</span><span class="p">]</span> <span class="p">=</span> <span class="n">bindingContext</span><span class="p">.</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValidField</span><span class="p">(</span><span class="n">subPropertyName</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">startedValid</span><span class="p">[</span><span class="n">subPropertyName</span><span class="p">])</span>
                <span class="p">{</span>
                    <span class="n">bindingContext</span><span class="p">.</span><span class="n">ModelState</span><span class="p">.</span><span class="n">AddModelError</span><span class="p">(</span><span class="n">subPropertyName</span><span class="p">,</span> <span class="n">validationResult</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
</code></pre></div>
<p>So at this point, we know one thing we need to do: implement our own model binder that inherits from <code>DefaultModelBinder</code>, overrides OnModelUpdated to hook in our custom logic, and ultimately call base.OnModelUpdated to run the default validation.  But before we implement that, we need to think about what our new update components will look like. </p>

<p>Conceptually, we&#39;re going to pass the model from the model binder (and the model can be of any type) to a component and that component is going to potentially modify properties on it directly based on its rules.  So let&#39;s define an interface <code>IModelUpdate</code> which does that, with the addition of ControllerContext:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">interface</span> <span class="n">IModelUpdate</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Update</span><span class="p">(</span><span class="kt">object</span> <span class="n">model</span><span class="p">,</span> <span class="n">ControllerContext</span> <span class="n">controllerContext</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>As mentioned, the model updates we&#39;d like to apply are:
- Decrypt specific properties based on annotations
- Bind values from the HTTP request</p>

<p>These become several implementations of <code>IModelUpdate</code> that are then plugged into our custom model binder, which looks like:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PreValidationModelUpdatingModelBinder</span> <span class="p">:</span> <span class="n">DefaultModelBinder</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">IModelUpdate</span><span class="p">&gt;</span> <span class="n">modelUpdates</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PreValidationModelUpdatingModelBinder</span><span class="p">(</span><span class="k">params</span> <span class="n">IModelUpdate</span><span class="p">[]</span> <span class="n">modelUpdates</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">modelUpdates</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">this</span><span class="p">.</span><span class="n">modelUpdates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IModelUpdate</span><span class="p">&gt;();</span>
            <span class="k">else</span>
                <span class="k">this</span><span class="p">.</span><span class="n">modelUpdates</span> <span class="p">=</span> <span class="n">modelUpdates</span><span class="p">.</span><span class="n">ToList</span><span class="p">();</span>
        <span class="p">}</span>      

        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelUpdated</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">controllerContext</span><span class="p">,</span> <span class="n">ModelBindingContext</span> <span class="n">bindingContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">modelUpdates</span><span class="p">.</span><span class="n">ToList</span><span class="p">().</span><span class="n">ForEach</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">bindingContext</span><span class="p">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">controllerContext</span><span class="p">));</span>           

            <span class="k">base</span><span class="p">.</span><span class="n">OnModelUpdated</span><span class="p">(</span><span class="n">controllerContext</span><span class="p">,</span> <span class="n">bindingContext</span><span class="p">);</span>            
        <span class="p">}</span>       
    <span class="p">}</span>    
</code></pre></div>
<p>As you can see, our model binder simply takes a collection of IModelUpdate components, overrides OnModelUpdated, calls each component, and then calls base.OnModelUpdated to have the default model binder run the model validations.  Each model updater is responsible for determining
if it actually cares to perform an update on the model; if not, it simply does nothing to it.  I&#39;ve omitted the implementations of the <code>IModelUpdate</code> components as they&#39;re pretty application specific, but they are in my <a href="https://gist.github.com/dlongest/387d2ce35fb6f45688b8">Github</a> if you&#39;d like to see them.  </p>

<p>This concludes a look at how we extended MVC to leverage its existing binding and validation functionality while letting us extend it in some pretty unique ways. </p>
 	
	</div>
  



 
	</div>
</div>
</div>
<nav id="pagination">
<ul>	
    	
     
	<li>
    <a href="/page2/" title="Next Page">Next &raquo;</a>
	</li>
     
</ul>
  </nav>
	
</body>
</html>