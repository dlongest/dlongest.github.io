<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Code Like A Champion</title>
		
		 <link href="/css/bootstrap.css" rel="stylesheet">
		 <link rel="icon" href="/images/logo.png" />
		 <script type="text/javascript" src="/js/jquery.js"></script>
		<script type="text/javascript" src="/js/bootstrap.js"></script>		
    <!-- Custom CSS -->
		<link href="/css/logo-nav.css" rel="stylesheet" />	
		<link href="/css/custom.css" rel="stylesheet" />
		<link rel="stylesheet" href="/css/solarized-dark.css" type="text/css"/> 

		<link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css' />
    </head>
    <body>
	 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">
                    <img id="logo" src='/images/logo.png' width="125" height="125" />
                </a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/about.html">About</a>
                    </li>
					  <li>
                        <a href="#">Categories</a>
                    </li>                                       
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>	

<div class="container">
<div class="row">
 <div class="col-lg-12">		
          
	<h2><a href="/2015/02/15/how-development-is-like-surgery.html">How Software Development is like Veterinary Medicine</a></h2>
	<div class="date">15 February 2015</div>	
	<div class="post">
	<p>My dad is a veterinarian at <a href="http://www.threechoptanimalclinic.com">Three Chopt Animal Clinic</a> in the Richmond area and has been for over 35 years.  When I was growing up, I observed quite a lot of veterinary procedures, far more than the average person would.  But I never really seriously considered going into the field, with the most common reason (usually given about me) is my general squeamishness related to blood.  I happen to love quotes and like most fields, the medical field is rife with them.  One of my dogs was unfortunately diagnosed this week with an incurable liver tumor so his time with us will be short.  When I was talking to my dad about the situation, he used a surgical axiom and it struck me how applicable it was to software development, particularly debugging and bug triage, which is consuming me as we try to wrap up the new identity platform integration.  In that spirit, this post will look at some common medical idioms and how they also apply to the seemingly unrelated field of software development.</p>

<h3>A chance to cut is a chance to cure</h3>

<p>For surgeons, this axiom is exactly what it sounds like:  giving the surgeon a chance to perform the procedure is giving the patient a chance at a cure.  And similarly, given a problem, most software developers leap to a code solution.  When time is tight and shipping dates are on the line, I think most of us believe that relaxing code freeze and giving us a chance to do what we do best will save the day.  And sometimes that&#39;s true.  In my current project , at least half a dozen times and counting I&#39;ve had to pull out what seemed like a miracle to work around the vendor&#39;s design or a bug in the platform or just do something to help move us along.  And most of the time, I asked to be given the chance to write some code in contravention of code freeze or other similar process guidelines.  And that&#39;s worked out for us.  But sometimes the cure does not require surgery or more code.  And sometimes the situation cannot be salvaged.  And I would be remiss if I didn&#39;t add the flip side axiom:  a chance to cut is a chance to kill.  As developers, there is always the chance that we will introduce a bug so we have to weigh the risk of introducing a bug against the benefit of authoring code when a situation is outside the bounds of normal processes.</p>

<h3>All bleeding eventually stops</h3>

<p>I&#39;m famous at work for saying this one in reference to struggling projects and I heard it from my dad who learned it from his boss when he started practicing veterinary medicine.  This phrase is a bit of gallows humor:  if a patient is bleeding, either a veterinarian will control the bleeding and save the patient or the patient will bleed out (at which point it will stop).  This phrase always reminds me that a tough situation will always come to an end.  Sometimes that means we&#39;ll salvage the situation, sometimes it will be ended with an unfortunate result.  But all we can do is focus on trying to save it while accepting that things might ultimately break against us.  </p>

<h3>If it's worth taking out, it's worth turning in</h3>

<p>In medicine this refers to the practice of turning into pathology any mass that is removed from a patient for follow-up analysis related to cause and effect.  In this day and age when unit testing is an almost universally accepted practice, I liken this saying to writing unit tests in response to bug reports.  The most common question I get from developers at work is either &quot;How can I start writing unit tests?&quot; or &quot;I&#39;m in a code-base, where should I start writing unit tests?&quot;  I usually ask &quot;Are there bugs you&#39;re fixing?&quot;  Bugs to me are the easiest way to start writing unit tests.  If you get a bug report, write a test that proves the bug exists.  Then all you&#39;ve got to do is write the code to make the test pass. That&#39;s it.  I&#39;m training a guy on my team as  .NET developer.  I got asked to look into a situation where data on-screen in an internal LOB application was being duplicated (but in the database it was fine).  This code was a few years old so it took quite a bit of effort to write a test to prove the bug in the code (a number of hours in fact).  But once I did that, I told my colleague &quot;All you&#39;ve got to do now is make the test pass.&quot;  I could have solved the problem in 5 minutes once I had the failing test, but I knew this would be a big win for him to make an actual production change in the code-base.  I typically look askance at someone who tells me they fixed a bug, but didn&#39;t check in any unit tests: how do they know it&#39;s solved?  How do they know they didn&#39;t introduce a new one?  So similar to submitting excised masses to pathology being a routine practice, developers should do likewise for bugs. </p>

<h3>Age is not a disease</h3>

<p>In medicine, just because a patient is of advanced age it does not automatically disqualify certain treatments.  Yes, age can and is a factor, but it&#39;s not the only one.  Similarly, just because a code-base has been around a long time, that does not mean it needs to be replaced with a newer one in a more contemporary technology.  At one company I worked, I supported all the systems for document collection.  Most of these were Windows services that read and loaded documents received on feeds we purchased, such as EDGAR documents from the SEC.  One of our most important ones was called PR Loader, which loaded press releases from a feed supplied by Acquire Media.  Press releases were of the utmost importance to us for two reasons.  One:  press releases by SEC regulation are where companies break news and it was worth big money to us (and our clients) to have access to them as fast as posssible.  And two:  we supplied investor relations solutions (i.e. a company&#39;s IR website) to some clients and it was a matter of regulation (and subject to fines) if press releases didn&#39;t reach their site at a specific time and these same PRs came to us on the Acquire feed (don&#39;t ask why they weren&#39;t uploaded directly).  And the PR Loader was written in a very old language that they told me was called X++ (which I&#39;d never heard of).  The loader was written over 10+ years previously and hadn&#39;t been changed in about 3 years when my team was doing a project that called for modifying it.  We batted around the idea of rewriting it in C#, but after analysis, the changes we needed to make could be added as a separate module without touching the core logic.  And since management did not feel comfortable taking the risk of rewriting it (or the time it would take plus the testing), it was faster to get a developer up to speed on the foreign language and have the one remaining developer (who at the time was a senior IT directory) do a thorough code review.  There is a lot of value inherent in legacy codebases.  The cost of producing them originally has been amortized over a long period and represents tremendous value to the enterprise: that should not be causally discarded just because of its age. </p>

<h3>Never be first to use a new treatment, or last</h3>

<p>Most developers do not work at companies whose goal is to be on the bleeding edge of technology.  The cost of being on the bleeding edge is you will do a lot of bleeding and for most enterprises, that is simply not necessary.  For most enterprises, if there is little documentation or knowledge out on the web on a topic, it should really give pause whether adopting a technology as part of a project is a sound business decision.  Perhaps it is, but often the lessons learned from it will be painful and expensive.  But on the other hand, being too late to pick up a new technology puts you far behind the competition.  If my company was still producing ASMX web services, it should really give us pause given the plethora of easier to use, widely accepted options out there.  The real moral of this lesson:  consider the full ramifications of adopting a technology and make sure you roll into its consideration the support and knowledge available out in the world about it. </p>

<h3>One CT scan is worth a thousand neurologists</h3>

<p>Speculation is free and easy.  And in many ways, fun.  But seldom does it gain us what we really need to solve a difficult situation:  data.  In the course of implementing the new cloud SaaS identity platform, its performance has at times not been what we expected or can accept.  And the vendor has given us a lot of stories about why it is the way it is or that it will be faster in production, or even that it&#39;s faster than we think.  And there were a lot of meetings to discuss everyone&#39;s opinions on the matter.  But I did something simple:  I got us data.  I added event logging on top of the client proxies that simply times all calls to the vendor&#39;s services and writes them (plus the method call name) into the event log.  From there it was easy to download the event logs and write an application to parse out the times and calculate standard descriptive statistics on them.  And they were eye-opening.  So much so that our IT management passed them to the vendor&#39;s management with a simple question:  how do you explain these numbers?  And they simply couldn&#39;t.  Thus began weeks of load testing and performance optimizations on their part with the data my login application could gather to show whether it was getting better or not.  So when there&#39;s argument and speculation, collect some data and at least argue about something rigorous.  </p>

<p>There are plenty more medical sayings I could include here and maybe I&#39;ll take another run at this one day, but hopefully you&#39;ve enjoyed this only-slightly-joking comparison between the fields of medicine and software development.</p>
 	
	</div>
	<hr />
      
	<h2><a href="/2015/02/14/logging-correlation-ids-mvc.html">Logging Correlation Identifiers in ASP.NET MVC</a></h2>
	<div class="date">14 February 2015</div>	
	<div class="post">
	<p>Over the months we&#39;ve been writing a new login application against a cloud SaaS platform, we have slowly evolved our logging strategy for the application.  The evolution occurred because we needed more and more information for diagnostics and triage related to bugs (sometimes in our custom application, often in the vendor product too) and performance issues.  Some of the logging we employed that wrote into the event log on the login app server (of which there are 2) included:</p>

<ul>
<li>Call times for the vendor services (SOAP and REST) as Windsor interceptors</li>
<li>Communication exceptions trying to reach the vendor services as Windsor interceptors</li> 
<li>Raw SOAP request and response messages as WCF behavior on the client proxy</li>
<li>Primary error page with reference ID shown to user as controller-view</li>
</ul>

<p>These error messages have been incredibly useful.  The call times have driven a lot of performance testing and improvements that have been put in place (coupled with a separate application I wrote to crunch the call times, which I might present separately).  The raw SOAP request/responses have been useful because many bugs come down to the vendor asking what was returned by their system (presumption being we were handling it wrong), but the responses often showed a &quot;smoking gun&quot; that the response was missing key information.  </p>

<p>Recently as we&#39;ve fought hard to move to deployment, I realized that there was a bit of an oversight in the logging:  while it wasn&#39;t too hard to trace backward through the log to identify a series of messages within a given use-case, it isn&#39;t the kind of thing anyone could do without a lot more knowledge of the platform calls (knowledge my team had gained over the last 9 months).  But there seemed conceptually a pretty simple solution to this problem:  all we needed was a way to correlate the log messages for a user within a single session.  I&#39;m not even interested in tracking the user across multiple different sessions (although if that happens, fine).  I principally just want a way that if creating an account requires transitioning through 3 or 4 screens and that causes 8-10 log messages (with everything turned up), we can tie those log messages together as a matter of rote.  </p>

<p>Obviously lots of ways to do this but the below will present one way I&#39;ve gone about it.  First, we have in place this logging interface:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp">  <span class="k">public</span> <span class="k">interface</span> <span class="n">ILog</span>
    <span class="p">{</span>
        <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="kt">object</span> <span class="n">obj</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span> <span class="kt">object</span> <span class="n">obj</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>This interface is actually just a wrapper around an in-house logging library we have; this one closes over that type (which requires basically an event ID be provided) so that components in the application can be agnostic to the event ID they&#39;re using, which is configured by Windsor in the root.</p>

<p>That yields this basic implementation that we inject throughout the application to components that are logging-aware:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">EventIdEnclosingLogger</span> <span class="p">:</span> <span class="n">ILog</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">EventId</span> <span class="n">eventId</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">EventIdEnclosingLogger</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span> <span class="n">EventId</span> <span class="n">eventId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">eventId</span> <span class="p">=</span> <span class="n">eventId</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">eventId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">eventId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">eventId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Log</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">,</span> <span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">eventId</span><span class="p">);</span>
        <span class="p">}</span>       
    <span class="p">}</span>
</code></pre></div>
<p>So given that I have a logging abstraction, what&#39;s an easy way I can introduce a a correlation ID into the mesages?  A decorator!  In case you&#39;re not aware, a decorator pattern allows the addition of functionality on top of an existing component.  So from the above types, I could define:</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="n">CorrelatingLogger</span> <span class="p">:</span> <span class="n">ILog</span>
    <span class="p">{</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILog</span> <span class="n">logger</span><span class="p">;</span>

        <span class="c1">//// elided</span>
    <span class="p">}</span>
</code></pre></div>
<p>So an ILog implementation is injected into the CorrelatingLogger, which can then enrich the parameters before calling into the inner logger implementation.  Mulitple layers of decorators can be applied, with the innermost implmentation finally doing the job.  But given our use of Windsor and interceptors, an interceptor was again the natural choice here.  That doesn&#39;t really alter the philosophy being employed here at all, just leverages the Windsor infrastructure.  </p>

<p>So this part probably makes sense, but I haven&#39;t answered the key question:  where am I getting the correlation IDs from and how will those be managed?  We could imbue the logging interceptor with the ability to manage the correlation IDs for us, but that feels like a single-responsibility violation: it should be responsible for computing appropriate log messages based on the correlation ID, not managing them.  Enter a new abstraction:  ICorrelationProvider.</p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">interface</span> <span class="n">ICorrelationProvider</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="nf">GetCorrelationIdentifier</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div>
<p>Simple enough, how will we power it?  Okay, now for the real debate.  First, the application is not backed by a database or store of its own (all of that being offloaded to the vendor stack) so no help there.  The most natural mechanism to pass state around during a single request is <code>HttpContext.Items</code>, which is a dictionary only available to the currently executing request (i.e. thread local, so there&#39;s no interference between other executing requests).  So that will work fine as storage during the request, but how will we ensure continuity of IDs across requests?  Simple enough we can use our good friend the cookie.  It&#39;s arguable we could/should have used Session, and that&#39;s a legitimate argument, but like I said, this is just one way to do it.  </p>

<p>We&#39;ve now identified that we will use a cookie to manage the correlation IDs between requests and we will essentially load it into <code>HttpContext.Items</code> at the first opportunity during a request.  I considered overriding the <code>Initialize</code> method in the controller and having that manage the state for me, but that spread out knowledge of the correlation ID key to two places:  the controller and the correlation provider.  After initially implementing it that way, I realized that piece of knowledge had to be in one place so I switched to the below implementation.</p>

<p>A few notes for the code you&#39;ll see below:</p>

<ul>
<li>We inject a lambda to provide us with the `HttpContextBase`, not the `HttpContext` itself since at the point when the provider is created, I have been burned by the context not being fully formed. Instead, we use the lambda as it's not until execution (when the context will be fully formed) that we actually need it.</li>
<li>We prioritize the value in the cookie over the one in Items so if there's a discrepancy for any reason, we allow the cookie to dictate whether we create a new ID (a GUID) and load it into Items or not.</li>
<li>If for some reason an exception is thrown while trying to create, obtain, or update the correlation ID, we will swallow it and return a hard-coded value.  This will let our system functionality continue unabated and make it obvious there's been an issue in the logging.  Hopefully though all such issues will be ironed out in development anyway, but we do not want the live functionality rendered unusuable simply because the log messages don't get this extra value.</li>
<li>GetCorrelationId violates CQS:  it both mutates system state (by adding/updating a cookie and items) and returns a value.  I felt the violation in this case was acceptable as it made the client code easier to follow.</li>
</ul>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp">    <span class="k">public</span> <span class="k">class</span> <span class="nc">HttpContextCorrelationProvider</span> <span class="p">:</span> <span class="n">ICorrelationProvider</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpContextBase</span><span class="p">&gt;</span> <span class="n">httpContext</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">correlationKey</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">HttpContextCorrelationProvider</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">HttpContextBase</span><span class="p">&gt;</span> <span class="n">httpContext</span><span class="p">,</span> <span class="kt">string</span> <span class="n">correlationKey</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;httpContext&quot;</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="n">httpContext</span> <span class="p">=</span> <span class="n">httpContext</span><span class="p">;</span>          
            <span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span> <span class="p">=</span> <span class="n">correlationKey</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetCorrelationIdentifier</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">correlationId</span> <span class="p">=</span> <span class="n">GetCorrelationId</span><span class="p">();</span>
                <span class="n">UpdateCookie</span><span class="p">(</span><span class="n">correlationId</span><span class="p">);</span>
                <span class="n">UpdateContext</span><span class="p">(</span><span class="n">correlationId</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">correlationId</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;123456&quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetCorrelationId</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">correlationCookie</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">];</span>

            <span class="kt">var</span> <span class="n">existsInContextItems</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">correlationCookie</span> <span class="p">==</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">existsInContextItems</span><span class="p">)</span>
                 <span class="k">return</span> <span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">correlationCookie</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">correlationCookie</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
            <span class="k">else</span> 
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateCookie</span><span class="p">(</span><span class="kt">string</span> <span class="n">correlationId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">CorrelationCookie</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cookies</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">HttpCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="p">(!</span><span class="n">CorrelationCookie</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">correlationId</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cookies</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">HttpCookie</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateContext</span><span class="p">(</span><span class="kt">string</span> <span class="n">correlationId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">hasId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">currentValue</span> <span class="p">=</span> <span class="n">hasId</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">currentValue</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="p">(!</span><span class="n">currentValue</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">correlationId</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Items</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">]</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>     

        <span class="k">public</span> <span class="n">HttpCookie</span> <span class="n">CorrelationCookie</span>
        <span class="p">{</span>
            <span class="k">get</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Cookies</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">correlationKey</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">HttpContextBase</span> <span class="n">context</span><span class="p">;</span>

        <span class="k">private</span> <span class="n">HttpContextBase</span> <span class="n">Context</span>
        <span class="p">{</span>
            <span class="k">get</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">context</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">httpContext</span><span class="p">();</span>

                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">context</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>Finally we have our <code>CorrelatingLogInterceptor</code> that ties all these pieces together.  You&#39;ll see that the interceptor simply fetches the first argument (which is always the message for our <code>ILog</code> type), adds the correlation ID to it, updates the method argument, then calls the inner logger.  You&#39;ll notice that the interceptor does not currently guard that it has been applied to a correct invocation.  In other words, if you 
configured this interceptor against a type that isn&#39;t ILog, the implementation will not notice or care (until an exception gets thrown).  We rely on Windsor to properly use our <code>IModelInterceptorsSelector</code> that contains the logic to apply the interceptor (not shown). </p>
<div class="highlight"><pre><code class="csharp language-csharp" data-lang="csharp"> <span class="k">public</span> <span class="k">class</span> <span class="nc">CorrelatingLogInterceptor</span> <span class="p">:</span> <span class="n">IInterceptor</span>
    <span class="p">{</span>       
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICorrelationProvider</span> <span class="n">provider</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">CorrelatingLogInterceptor</span><span class="p">(</span><span class="n">ICorrelationProvider</span> <span class="n">provider</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">provider</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">&quot;provider&quot;</span><span class="p">);</span>

            <span class="k">this</span><span class="p">.</span><span class="n">provider</span> <span class="p">=</span> <span class="n">provider</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">GetMessageArgument</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">correlationId</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">GetCorrelationIdentifier</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">newMessage</span> <span class="p">=</span> <span class="n">UpdateMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">);</span>
                <span class="n">UpdateArgument</span><span class="p">(</span><span class="n">invocation</span><span class="p">,</span> <span class="n">newMessage</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="n">invocation</span><span class="p">.</span><span class="n">Proceed</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetMessageArgument</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">First</span><span class="p">()</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">UpdateMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">,</span> <span class="kt">string</span> <span class="n">correlationId</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}\n{1}: {2}&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s">&quot;Correlation ID: &quot;</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="nf">UpdateArgument</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">,</span> <span class="kt">string</span> <span class="n">newMessage</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">invocation</span><span class="p">.</span><span class="n">SetArgumentValue</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">newMessage</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<p>This concludes the write-up on correlation event log entries across an MVC application using a Windsor interceptor and custom correlation provider on top of <code>HttpContext.Items</code>.  </p>
 	
	</div>
	<hr />
  



 
	</div>
</div>
</div>
<ul class="pager">
 	
	  
	 <li>
    <a  href="/page2/" title="Older">Older &raquo;</a>
	</li>
     
</ul>		
   


  
	
</body>
</html>